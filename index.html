<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sticky Radio Player</title>
  <style>
    body.light {
      --bg: #fff;
      --text: #000;
    }
    body.dark {
      --bg: #000;
      --text: #fff;
    }
    body {
      margin: 0;
      font-family: sans-serif;
    }
    #radio-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      z-index: 9999;
    }
    #left-section {
      display: flex;
      align-items: center;
    }
    #album-art {
      width: 50px;
      height: 50px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }
    #play-btn {
      background: #e00;
      color: #fff;
      border: none;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    #song-info {
      flex-grow: 1;
      text-align: center;
      padding: 0 20px;
    }
    #volume-slider {
      width: 100px;
      margin-right: 15px;
      accent-color: #007bff; /* Blue slider */
    }
    #theme-toggle, #powered-by {
      background: #555;
      color: #fff;
      border: none;
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 5px;
    }
    #powered-by {
      background: #333;
    }
  </style>
</head>
<body>
  <div id="radio-player">
    <div id="left-section">
      <img id="album-art" src="" alt="Album Art" />
      <button id="play-btn">▶️</button>
    </div>
    <div id="song-info">Loading...</div>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" />
    <button id="theme-toggle">Toggle Theme</button>
    <button id="powered-by" onclick="window.open('https://myradionest.com','_blank')">Powered by Radio Nest</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const streamUrl = urlParams.get("stream");
    const metadataUrl = urlParams.get("metadata");

    const audio = new Audio(streamUrl);
    audio.crossOrigin = "anonymous";

    const playBtn = document.getElementById("play-btn");
    const songInfo = document.getElementById("song-info");
    const albumArt = document.getElementById("album-art");
    const themeToggle = document.getElementById("theme-toggle");
    const volumeSlider = document.getElementById("volume-slider");

    let isPlaying = false;
    let currentSong = "";
    let lastChangeTime = Date.now();
    const FALLBACK_TIMEOUT = 600000; // 10 minutes

    document.body.classList.add("dark");

    playBtn.addEventListener("click", () => {
      if (isPlaying) {
        audio.pause();
        playBtn.textContent = "▶️";
      } else {
        audio.play();
        playBtn.textContent = "⏸️";
      }
      isPlaying = !isPlaying;
    });

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    });

    volumeSlider.addEventListener("input", () => {
      audio.volume = volumeSlider.value;
    });

    function fetchMetadata() {
      if (!metadataUrl) return;

      fetch(metadataUrl)
        .then((res) => res.text())
        .then((data) => {
          const song = data.trim();

          // Immediate fallback if metadata is empty
          if (!song) {
            showFallback();
            return;
          }

          if (song !== currentSong) {
            currentSong = song;
            lastChangeTime = Date.now();
            songInfo.textContent = song;
            fetchAlbumArt(song);
          } else {
            // If metadata hasn't changed for 10 minutes, fallback
            if (Date.now() - lastChangeTime > FALLBACK_TIMEOUT) {
              showFallback();
            }
          }
        })
        .catch(() => {
          showFallback();
        });
    }

    function showFallback() {
      songInfo.textContent = "Radio - On Air";
      setDefaultArt();
    }

    function fetchAlbumArt(song) {
      const [artist, title] = song.split(" - ");
      if (!artist || !title) {
        setDefaultArt();
        return;
      }

      const apiUrl = `https://theaudiodb.com/api/v1/json/123/searchtrack.php?s=${encodeURIComponent(artist)}&t=${encodeURIComponent(title)}`;

      fetch(apiUrl)
        .then((res) => res.json())
        .then((data) => {
          const art = data?.track?.[0]?.strTrackThumb;
          albumArt.src = art || "https://www.theaudiodb.com/images/media/track/thumb/default.png";
        })
        .catch(setDefaultArt);
    }

    function setDefaultArt() {
      albumArt.src = "https://www.theaudiodb.com/images/media/track/thumb/default.png";
    }

    setInterval(fetchMetadata, 5000);
    fetchMetadata();
  </script>
</body>
</html>
