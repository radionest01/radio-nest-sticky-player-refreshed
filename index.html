<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sticky Radio Player</title>
  <style>
    body.light {
      --bg: #fff;
      --text: #000;
    }
    body.dark {
      --bg: #000;
      --text: #fff;
    }
    body {
      margin: 0;
      font-family: sans-serif;
    }

    #radio-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 90px;
      box-sizing: border-box;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      z-index: 9999;
    }

    #left-section {
      display: flex;
      align-items: center;
      min-width: 140px;
    }

    #album-art {
      width: 40px;
      height: 40px;
      object-fit: cover;
      margin-right: 8px;
      border-radius: 4px;
      background: #111;
    }

    #play-btn {
      border: 2px solid var(--text);
      color: var(--text);
      background: transparent;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 0;
    }
    #play-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    #song-info {
      flex-grow: 1;
      text-align: center;
      font-size: 14px;
      padding: 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #right-section {
      display: flex;
      align-items: center;
      margin-right: 10px; /* nudges everything slightly left */
    }

    #volume-slider {
      width: 90px;
      margin-right: 6px;
      accent-color: #007bff;
    }

    #theme-toggle, #powered-by {
      background: #555;
      color: #fff;
      border: none;
      padding: 6px 8px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    #powered-by {
      background: #333;
    }
  </style>
</head>
<body>
  <div id="radio-player">
    <div id="left-section">
      <img id="album-art" src="" alt="Album Art" />
      <button id="play-btn" aria-label="Play"></button>
    </div>

    <div id="song-info">Loading...</div>

    <div id="right-section">
      <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" />
      <button id="theme-toggle">Toggle Theme</button>
      <button id="powered-by" onclick="window.open('https://myradionest.com','_blank')">Powered by Radio Nest</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const streamUrl = urlParams.get("stream");
    const metadataUrl = urlParams.get("metadata");

    const DEFAULT_ART = "https://i.ibb.co/ccmTh1kB/ON-Air.png";
    const audio = new Audio(streamUrl);
    audio.crossOrigin = "anonymous";

    const playBtn = document.getElementById("play-btn");
    const songInfo = document.getElementById("song-info");
    const albumArt = document.getElementById("album-art");
    const themeToggle = document.getElementById("theme-toggle");
    const volumeSlider = document.getElementById("volume-slider");

    let isPlaying = false;
    let currentSong = "";
    let lastChangeTime = Date.now();
    const FALLBACK_TIMEOUT = 600000;

    const getPlayIcon = () => `
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7-11-7z"></path></svg>
    `;
    const getPauseIcon = () => `
      <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"></path></svg>
    `;

    function updatePlayButton() {
      playBtn.innerHTML = isPlaying ? getPauseIcon() : getPlayIcon();
      playBtn.setAttribute("aria-label", isPlaying ? "Pause" : "Play");
    }

    function setDefaultArt() {
      albumArt.src = DEFAULT_ART;
    }
    albumArt.onerror = setDefaultArt;
    setDefaultArt();

    document.body.classList.add("dark");
    updatePlayButton();

    playBtn.addEventListener("click", () => {
      if (isPlaying) {
        audio.pause();
      } else {
        audio.play();
      }
      isPlaying = !isPlaying;
      updatePlayButton();
    });

    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    });

    volumeSlider.addEventListener("input", () => {
      audio.volume = volumeSlider.value;
    });

    function showFallback() {
      songInfo.textContent = "Radio - On Air";
      setDefaultArt();
    }

    async function fetchMetadata() {
      if (!metadataUrl) return;

      try {
        const res = await fetch(metadataUrl, { cache: "no-store" });
        const contentType = res.headers.get("content-type") || "";
        let song = "";

        if (contentType.includes("application/json")) {
          const data = await res.json();
          song = (data.currentSong || data.songtitle || data.streamTitle || "").trim();
        } else {
          const text = await res.text();
          if (text.trim().startsWith("<")) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "application/xml");
            const songNode =
              xml.querySelector("SONGTITLE") ||
              xml.querySelector("currentSong") ||
              xml.querySelector("songtitle") ||
              xml.querySelector("streamTitle");
            song = (songNode ? songNode.textContent : "").trim();
          } else {
            song = text.trim();
          }
        }

        if (!song) {
          showFallback();
          return;
        }

        if (song !== currentSong) {
          currentSong = song;
          lastChangeTime = Date.now();
          songInfo.textContent = song;
          fetchAlbumArt(song);
        } else if (Date.now() - lastChangeTime > FALLBACK_TIMEOUT) {
          showFallback();
        }
      } catch {
        showFallback();
      }
    }

    async function fetchAlbumArt(song) {
      const [artist, title] = song.split(" - ").map(s => s && s.trim());
      if (!artist || !title) {
        setDefaultArt();
        return;
      }

      const apiUrl = `https://theaudiodb.com/api/v1/json/123/searchtrack.php?s=${encodeURIComponent(artist)}&t=${encodeURIComponent(title)}`;

      try {
        const res = await fetch(apiUrl, { cache: "no-store" });
        const data = await res.json();
        const art = data?.track?.[0]?.strTrackThumb;
        albumArt.src = art || DEFAULT_ART;
      } catch {
        setDefaultArt();
      }
    }

    setInterval(fetchMetadata, 5000);
    fetchMetadata();
  </script>
</body>
</html>
